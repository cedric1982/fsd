<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FSD – Karte</title>

  <!-- Socket.IO (wie im Dashboard) -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root{
      --bg: #0b0f17;
      --panel: rgba(255,255,255,.04);
      --border: rgba(255,255,255,.07);
      --muted: #8b93a7;
      --text: #e9edf7;
    }

    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); }

    .app-shell{
      display: grid;
      grid-template-columns: 260px 1fr;
      min-height: 100vh;
    }
    .sidebar{
      border-right: 1px solid var(--border);
      background: rgba(0,0,0,.25);
      padding: 18px 14px;
    }
    .brand{ padding: 10px 10px 16px; }
    .brand h2{ margin: 0; font-size: 16px; }
    .brand p{ margin: 6px 0 0; color: var(--muted); font-size: 12px; }

    .nav-link{
      display: block;
      padding: 10px 10px;
      border-radius: 10px;
      color: var(--text);
      text-decoration: none;
      margin: 6px 0;
      background: transparent;
      border: 1px solid transparent;
    }
    .nav-link:hover{
      background: rgba(255,255,255,.03);
      border-color: var(--border);
    }
    .nav-link.active{
      background: rgba(255,255,255,.06);
      border-color: var(--border);
    }

    .main{
      padding: 16px;
    }
    .panel{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
    }
    #map{
      height: calc(100vh - 32px);
      width: 100%;
    }

    /* Popup lesbar */
    .leaflet-popup-content-wrapper { background: #0f1523; color: var(--text); }
    .leaflet-popup-tip { background: #0f1523; }

    /* --- Aircraft Icon (rotierbar) --- */
    .aircraft-wrapper{
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      transform-origin: 50% 50%;
      will-change: transform;
    }

    /* Das SVG wird als <img> geladen; Größe über CSS */
    .aircraft-icon{
      width: 100%;
      height: 100%;
      pointer-events: none;
      user-select: none;
      -webkit-user-drag: none;
    }

    /* Optional: Callsign-Label unter dem Icon */
    .aircraft-label {
      margin-top: 2px;
      text-align: center;
      font: 12px system-ui, sans-serif;
      color: var(--text);
      text-shadow: 0 1px 2px rgba(0,0,0,.8);
      white-space: nowrap;
      pointer-events: none;
    }

    @media (max-width: 992px){
      .app-shell{ grid-template-columns: 1fr; }
      #map{ height: 70vh; }
    }
  </style>
</head>

<body>
  <div class="app-shell">
    <aside class="sidebar">
      <div class="brand">
        <h2>FSD Dashboard</h2>
        <p>Live Map Ansicht</p>
      </div>

      <a class="nav-link" href="/">Dashboard</a>
      <a class="nav-link" href="/users">Benutzerverwaltung</a>
      <a class="nav-link active" href="/map">Karte</a>
    </aside>

    <main class="main">
      <div class="panel">
        <div id="map"></div>
      </div>
    </main>
  </div>

  <script>
    // Karte
    const map = L.map('map', { worldCopyJump: true, zoomSnap: 0.5, zoomDelta: 0.5 }).setView([20, 0], 2);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // Marker pro Callsign
    const markers = new Map();

    function popupHtml(c) {
      const hdg = (c.hdg_deg_round ?? c.hdg_deg ?? "-");
      const alt = (c.alt ?? "-");
      const gs  = (c.gs ?? "-");
      return `
        <div style="font-family:system-ui,sans-serif;font-size:14px">
          <b>${c.callsign}</b><br/>
          HDG: ${hdg}&deg;<br/>
          ALT: ${alt} ft<br/>
          GS: ${gs} kt
        </div>
      `;
    }

    // Aircraft-Icon (SVG-Datei aus deinem Projekt)
    // Pfad ist relativ zu map.html (bei /map ausgeliefert): /assets/icons/a320.svg
    const AIRCRAFT_ICON_URL = "/static/a320.svg";

    // Falls dein SVG nicht nach Norden zeigt, hier korrigieren (häufig: -90 oder +90)
    const ICON_HEADING_OFFSET_DEG = 0;

    function makeAircraftDivIcon(headingDeg, callsign = "") {
      const safeHdg = Number.isFinite(headingDeg) ? headingDeg : 0;
      const rotated = safeHdg + ICON_HEADING_OFFSET_DEG;

      const labelHtml = callsign ? `<div class="aircraft-label">${callsign}</div>` : "";

      const html = `
        <div class="aircraft-wrapper" style="transform: rotate(${rotated}deg);">
          <img src="${AIRCRAFT_ICON_URL}" class="aircraft-icon">
          ${labelHtml}
        </div>
      `;

      return L.divIcon({
        className: "",
        html,
        iconSize: [28, 28],
        iconAnchor: [14, 14]
      });
    }


    function applyClients(clients) {
      const seen = new Set();

      for (const c of (clients || [])) {
        if (!c || typeof c.lat !== 'number' || typeof c.lon !== 'number') continue;
        if (!c.callsign) continue;

        const callsign = c.callsign;
        seen.add(callsign);

        const latlng = [c.lat, c.lon];

        // Heading bevorzugt rounded, sonst float
        const hdg = (Number.isFinite(c.hdg_deg_round) ? c.hdg_deg_round :
                     Number.isFinite(c.hdg_deg) ? c.hdg_deg : 0);

        let marker = markers.get(callsign);

        if (!marker) {
          marker = L.marker(latlng, {
            icon: makeAircraftDivIcon(hdg, callsign),
            keyboard: false
          }).addTo(map);

          marker.bindPopup(popupHtml(c));
          markers.set(callsign, marker);
        } else {
          marker.setLatLng(latlng);

          // Icon aktualisieren, wenn sich Heading ändert
          marker.setIcon(makeAircraftDivIcon(hdg, callsign));
          marker.setPopupContent(popupHtml(c));
        }
      }

      // Entfernen, wenn nicht mehr da
      for (const [cs, marker] of markers.entries()) {
        if (!seen.has(cs)) {
          map.removeLayer(marker);
          markers.delete(cs);
        }
      }
    }

    // Initialer Snapshot
    (async () => {
      try {
        const res = await fetch('/api/live_snapshot', { cache: 'no-store' });
        if (res.ok) {
          const data = await res.json();
          applyClients(data.clients || []);
        }
      } catch (e) {}
    })();

    // Live Updates via Socket.IO
    const socket = io();
    socket.on("live_clients", (data) => {
      applyClients((data && data.clients) ? data.clients : []);
    });
  </script>
</body>
</html>
