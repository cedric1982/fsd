<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FSD Server Dashboard</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background-color: #0d1117;
            color: #c9d1d9;
        }
        .sidebar {
            background-color: #161b22;
            min-height: 100vh;
            padding: 20px;
        }
        .sidebar a {
            color: #8b949e;
            text-decoration: none;
            display: block;
            margin: 10px 0;
        }
        .sidebar a.active {
            color: #fff;
            font-weight: bold;
        }
        .card {
            background-color: #1e2329;
            border: none;
            color: #c9d1d9;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }
        .table thead {
            background-color: #21262d;
        }
        .table tbody tr:hover {
            background-color: #2b3138;
        }
        .status-running {
            background-color: #238636;
            color: #fff;
        }
        .status-offline {
            background-color: #d73a49;
            color: #fff;
        }
        .btn-refresh {
            background-color: #238636;
            color: white;
        }
        .btn-refresh:hover {
            background-color: #2ea043;
        }
    </style>
</head>

<body>
<div class="container-fluid">
    <div class="row">

        <!-- Sidebar -->
        <nav class="col-md-2 d-none d-md-block sidebar">
            <h4 class="text-white mb-4">ðŸ§­ FSD Manager</h4>
            <a href="/" class="active">Dashboard</a>
            <a href="/users">Benutzerverwaltung</a>
        </nav>

        <!-- Main content -->
        <main class="col-md-10 ms-sm-auto px-4">

            <div class="pt-3 pb-2 mb-3 border-bottom">
                <h2 class="text-white">FSD Server Dashboard</h2>
            </div>

            <!-- Status -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card text-center p-3 status-offline" id="status-card">
                        <h5>Status</h5>
                        <p class="fs-4" id="status-text">offline</p>
                        <h6>PID: <span id="pid-text">-</span></h6>
                        <h6>Uptime: <span id="uptime-text">-</span></h6>
                        <button class="btn btn-refresh mt-2" onclick="location.reload()">ðŸ”„ Neu laden</button>
                    </div>
                </div>
            </div>

            <!-- Clients -->
            <div class="card p-3 mb-4">
                <h4>ðŸ›« Aktive Clients</h4>
                <table class="table mt-3" id="clients-table">
                    <thead>
                        <tr>
                            <th>Callsign</th>
                            <th>Typ</th>
                            <th>Latitude</th>
                            <th>Longitude</th>
                            <th>Altitude</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="5" class="text-center text-muted">
                                Keine aktiven Clients
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Logins -->
            <div class="card p-3">
                <h4>ðŸ“‹ Letzte Loginversuche</h4>
                <table class="table mt-3" id="logins-table">
                    <thead>
                        <tr>
                            <th>Zeit</th>
                            <th>Callsign</th>
                            <th>CID</th>
                            <th>Status</th>
                            <th>Nachricht</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="5" class="text-center text-muted">
                                Keine Logins vorhanden
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

        </main>
    </div>
</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<script>
const socket = io();

/* -------------------------------------------------
   Hilfsfunktion: Uptime formatieren
------------------------------------------------- */
function formatUptime(seconds) {
    seconds = Number(seconds) || 0;
    const d = Math.floor(seconds / 86400);
    seconds %= 86400;
    const h = Math.floor(seconds / 3600);
    seconds %= 3600;
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;

    const parts = [];
    if (d > 0) parts.push(`${d}d`);
    if (h > 0 || d > 0) parts.push(`${h}h`);
    parts.push(`${m}m`);
    parts.push(`${s}s`);
    return parts.join(" ");
}

/* -------------------------------------------------
   WebSocket: Verbindung
------------------------------------------------- */
socket.on("connect", () => {
    console.log("âœ… Verbunden mit WebSocket");
});

/* -------------------------------------------------
   Live-Status (PID + Uptime, jede Sekunde)
------------------------------------------------- */
socket.on("fsd_status", (data) => {
    const statusText = document.getElementById("status-text");
    const pidText = document.getElementById("pid-text");
    const uptimeText = document.getElementById("uptime-text");
    const statusCard = document.getElementById("status-card");

    if (!data) return;

    statusText.textContent = data.status || "offline";
    pidText.textContent =
        (data.pid !== null && data.pid !== undefined) ? data.pid : "-";

    if (data.status === "running") {
        uptimeText.textContent = formatUptime(data.uptime_sec);
        statusCard.classList.remove("status-offline");
        statusCard.classList.add("status-running");
    } else {
        uptimeText.textContent = "-";
        statusCard.classList.remove("status-running");
        statusCard.classList.add("status-offline");
    }
});

/* -------------------------------------------------
   Status-Update aus status.json (Clients, Logins)
------------------------------------------------- */
socket.on("status_update", (data) => {
    if (!data) return;

    /* Clients */
    const clientsTable = document.querySelector("#clients-table tbody");
    clientsTable.innerHTML = "";

    if (data.clients && data.clients.length > 0) {
        data.clients.forEach(c => {
            clientsTable.innerHTML += `
                <tr>
                    <td>${c.callsign}</td>
                    <td>${c.type}</td>
                    <td>${parseFloat(c.lat).toFixed(6)}</td>
                    <td>${parseFloat(c.lon).toFixed(6)}</td>
                    <td>${c.alt}</td>
                </tr>`;
        });
    } else {
        clientsTable.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-muted">
                    Keine aktiven Clients
                </td>
            </tr>`;
    }

    /* Logins (optional) */
    const loginsTable = document.querySelector("#logins-table tbody");
    loginsTable.innerHTML = "";

    if (data.logins && data.logins.length > 0) {
        data.logins.forEach(l => {
            loginsTable.innerHTML += `
                <tr>
                    <td>${l.time}</td>
                    <td>${l.callsign}</td>
                    <td>${l.cid}</td>
                    <td>${l.status}</td>
                    <td>${l.message}</td>
                </tr>`;
        });
    } else {
        loginsTable.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-muted">
                    Keine Logins vorhanden
                </td>
            </tr>`;
    }
});
</script>

</body>
</html>
