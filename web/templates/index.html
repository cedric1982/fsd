<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FSD Dashboard</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

  <style>
    :root{
      --bg:#0d1117;--panel:#111822;--border:rgba(255,255,255,.07);
      --muted:#8b949e;--text:#c9d1d9;
    }
    body{background:var(--bg);color:var(--text)}
    .badge-soft{border:1px solid var(--border);background:rgba(255,255,255,.04);
      padding:6px 10px;border-radius:999px;font-size:12px;color:#fff}
    .led{width:10px;height:10px;border-radius:50%;background:#d73a49}
    .led.ok{background:#2ea043}
    .table-darkish{background:var(--panel)}
    .table-darkish td,.table-darkish th{color:#fff;border-color:var(--border)}
  </style>
</head>

<body>
<div class="container-fluid p-3">

  <div class="d-flex justify-content-between mb-3">
    <h3>FSD Server Dashboard</h3>
    <span class="badge-soft">
      <span class="led" id="led"></span>
      <span id="status-badge-text">OFFLINE</span>
    </span>
  </div>

  <table class="table table-darkish table-hover align-middle">
    <thead>
      <tr>
        <th>Callsign</th>
        <th>Typ</th>
        <th class="text-end">HDG</th>
        <th>Latitude</th>
        <th>Longitude</th>
        <th class="text-end">Altitude</th>
      </tr>
    </thead>
    <tbody id="clients-body">
      <tr>
        <td colspan="6" class="text-center text-muted">Keine aktiven Clients</td>
      </tr>
    </tbody>
  </table>

</div>

<script>
  const socket = io();

  let lastClients = [];
  let liveMode = false;

  function setStatusUI(status){
    const led = document.getElementById("led");
    const txt = document.getElementById("status-badge-text");
    if ((status||"").toLowerCase()==="running"){
      led.classList.add("ok");
      txt.textContent="RUNNING";
    } else {
      led.classList.remove("ok");
      txt.textContent="OFFLINE";
    }
  }

  function renderClients(clients){
    const tbody = document.getElementById("clients-body");
    if (!clients || clients.length===0){
      tbody.innerHTML =
        `<tr><td colspan="6" class="text-center text-muted">
          Keine aktiven Clients</td></tr>`;
      return;
    }

    tbody.innerHTML = clients.map(c=>`
      <tr>
        <td><span class="badge-soft">${c.callsign||"-"}</span></td>
        <td>${c.type||"-"}</td>
        <td class="text-end">
          ${typeof c.hdg_deg==="number" ? Math.round(c.hdg_deg)+"Â°" : "-"}
        </td>
        <td>${Number(c.lat||0).toFixed(6)}</td>
        <td>${Number(c.lon||0).toFixed(6)}</td>
        <td class="text-end">${c.alt||"-"}</td>
      </tr>
    `).join("");
  }

  socket.on("connect", ()=>{
    console.log("[socket] connected");
  });

  socket.on("fsd_status", (data)=>{
    if (!data) return;
    setStatusUI(data.status);
  });

  socket.on("status_update", (data)=>{
    if (liveMode) return;
    if (Array.isArray(data.clients)){
      lastClients = data.clients;
      renderClients(lastClients);
    }
  });

  socket.on("live_clients", (payload)=>{
    if (!payload || !Array.isArray(payload.clients)) return;
    if (payload.clients.length>0){
      liveMode = true;
      lastClients = payload.clients;
      renderClients(lastClients);
    }
  });
</script>

</body>
</html>
